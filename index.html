<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Grin Blockchain Explorer on IPFS</title>
    <script language="javascript"  src="https://code.jquery.com/jquery-1.4.2.min.js"></script>
  </head>

  <body>
    <h1>Grin Blockchain Explorer on IPFS</h1>
    (alpha relase - do not trust this data yet)
    <br><br>
    Block Navigation:&nbsp;&nbsp;
    <a href="javascript:prevPage()" id="btn_prev">Previous</a>
    &nbsp;&nbsp;
    <a href="javascript:nextPage()" id="btn_next">Next</a>
    &nbsp;&nbsp; -- &nbsp;&nbsp;
    <a href="javascript:firstPage()" id="btn_first">First</a>
    &nbsp;&nbsp;
    <a href="javascript:lastPage()" id="btn_last">Last</a>
    &nbsp;&nbsp; -- &nbsp;&nbsp;
    <a href="javascript:jumpToPage()" id="btn_jtp">JumpTo</a>
    <input name="jumpTo" type="text" size="10" id="jumpTo" class="jumpTo"/>
    <br><br>
    <div id="listingTable"></div>
    <span id="page"></span>

  </body>

<script>
    var base_url = window.location.origin + "/ipns/k51qzi5uqu5di6j7rwnp4b2bb98nh1dwypwaymemx044kwnap8d0p1qmghhjpf" // + window.location.pathname.split( '/' )[2]
    var pageCount = getNumBlocks();
    var current_page = pageCount;
    var cache = {};

    function prevPage()
    {
        if (current_page > 0) {
            current_page--;
            renderPage();
        }
    }

    function nextPage()
    {
        if (current_page < pageCount) {
            current_page++;
            renderPage();
        }
    }

    
    function firstPage()
    {
        current_page = 0
        renderPage();
    }

    function lastPage()
    {
        current_page = pageCount
        renderPage();
    }


    function jumpToPage()
    {
	var page = document.getElementsByClassName("jumpTo")[0].value;
	if(!page) {
	    document.getElementsByClassName("jumpTo")[0].value = current_page
	    return;
	}
	page_int = parseInt(page)
        if(isNaN(page_int) || page_int < 0 || page_int > pageCount) {
	    document.getElementsByClassName("jumpTo")[0].value = current_page
	    return;
        }
	current_page = page
	renderPage()
    }

    function renderPage()
    {
        var btn_next = document.getElementById("btn_next");
        var btn_prev = document.getElementById("btn_prev");
        var listing_table = document.getElementById("listingTable");
        var page_span = document.getElementById("page");
    
        // Validate page number
        if (current_page < 0) current_page = 0;
        if (current_page > pageCount) current_page = pageCount;

	// Init
	document.getElementsByClassName("jumpTo")[0].value = "";
        listing_table.innerHTML = "";

	// Fetch and format block data
	var block_data = getBlockData(current_page)
	var block_string = JSON.stringify(block_data,null,'\t');
	listing_table.innerHTML += "Viewing Block Data for height <b>" + current_page + "</b> (of " +pageCount + "):";
	listing_table.innerHTML += "<br><br>";
        listing_table.innerHTML += "<pre>" + block_string + "</pre>";
	listing_table.innerHTML += "<br><br>";

	page_span.innerHTML = ""; // Whats this?
    
	// Manage the buttons - grey out invlid direction from current block
        if (current_page == 0) {
            btn_prev.style.color = "#707070";
        } else {
            btn_prev.style.color = "#0000EE";
        }
    
        if (current_page == pageCount) {
            btn_next.style.color = "#707070";
        } else {
            btn_next.style.color = "#0000EE";
        }

	// Beg for help for this pathetic webui.  Please help add some color at least :-|
        listing_table.innerHTML += "<br><br>"
	listing_table.innerHTML += "Please help improve this explorer UI: <A href=\"https://github.com/bladedoyle/grin_ipfs_explorer\">github</a>"
    }
    
    // Get content of url as json
    function getJson(url){
      try {
        $.get(base_url+'/'+url, function(data, status) {
	    if(data === undefined) {
                console.log("Hello undefined world!");
                return
            }
            height = data["header"]["height"]
            cache[height] = data;
            renderPage();
            console.log("Hello good world!");
          });
      }
      catch(err) {
        return null;
      }
    }

    // Get num blocks
    function getNumBlocks() {
      var request = new XMLHttpRequest();
      try {
        request.open('GET', base_url+'/height', false);
        request.send(null);
        var height_data = JSON.parse(request.responseText);
        return parseInt(height_data["height"]);
      }
      catch(err) {
        return null;
      }
    }

    // Get block by height as JSON
    //   # XXX TODO:  support more fork versions
    function getBlockData(height) {
      if(height in cache) {
          return cache[height]
      }
      var dir = Math.trunc(parseInt(height) / 10000)
      var data = getJson(dir + '/' + height)
      return "loading block data for height: "+height
    }

window.onload = function() {
    renderPage();
};
  </script>
</html>

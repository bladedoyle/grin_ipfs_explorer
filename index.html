<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Grin Blockchain Explorer on IPFS</title>
    <script language="javascript"  src="http://code.jquery.com/jquery-1.4.2.min.js"></script>
  </head>

  <body>
    <h1>Grin Blockchain Explorer on IPFS</h1>
    Block Navigation:&nbsp;&nbsp;
    <a href="javascript:prevPage()" id="btn_prev">Previous</a>
    &nbsp;&nbsp;
    <a href="javascript:nextPage()" id="btn_next">Next</a>
    <br><br>
    <div id="listingTable"></div>
    <span id="page"></span>

  </body>

<script>
    var base_url = window.location.origin + "/ipns/k51qzi5uqu5di6j7rwnp4b2bb98nh1dwypwaymemx044kwnap8d0p1qmghhjpf" // + window.location.pathname.split( '/' )[2]
    var pageCount = getNumBlocks();
    var current_page = pageCount;

    function prevPage()
    {
        if (current_page > 1) {
            current_page--;
            changePage(current_page);
        }
    }

    function nextPage()
    {
        if (current_page < pageCount) {
            current_page++;
            changePage(current_page);
        }
    }

    function changePage(page)
    {
        var btn_next = document.getElementById("btn_next");
        var btn_prev = document.getElementById("btn_prev");
        var listing_table = document.getElementById("listingTable");
        var page_span = document.getElementById("page");
    
        // Validate page
        if (page < 1) page = 1;
        if (page > pageCount) page = pageCount;
    
        listing_table.innerHTML = "";
    
	var block_data = getBlockData(page)
	var block_string = JSON.stringify(block_data,null,'\t');

        listing_table.innerHTML += "Viewing Block Data for height " + page + " (of " +pageCount + "):<br><br><pre>" + block_string + "</pre><br><br>";
    
	page_span.innerHTML = ""; // Whats this?
    
        if (page == 1) {
            btn_prev.style.visibility = "visible";
            btn_next.style.color = "#707070";
        } else {
            btn_prev.style.visibility = "visible";
            btn_next.style.color = "#0000EE";
        }
    
        if (page == pageCount) {
            btn_next.style.visibility = "visible";
            btn_next.style.color = "#707070";
        } else {
            btn_next.style.visibility = "visible";
            btn_next.style.color = "#0000EE";
        }

	    listing_table.innerHTML += "<br><br>Please help improve this explorer UI: <A href=\"https://github.com/bladedoyle/grin_ipfs_explorer\">github</a><br><br>"
    }
    
    // Get content of url as json
    function getJson(url){
      var request = new XMLHttpRequest();
      request.open('GET', base_url+'/'+url, false);
      request.send(null);
      return JSON.parse(request.responseText);
    }

    // Get num blocks
    function getNumBlocks() {
      var height_data = getJson('height') 
      return parseInt(height_data["height"])
    }

    // Get block by height as JSON
    function getBlockData(height) {
      var dir = Math.trunc(parseInt(height) / 10000)
      var data = getJson(dir + '/' + height)
      return data
    }

window.onload = function() {
    changePage(pageCount);
};
  </script>
</html>
